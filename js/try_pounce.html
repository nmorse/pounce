
<html>
  <head>
    <script src="dist/parser.js"></script>
    <script src="dist/runtime.js"></script>
    <!--<script src="test/runtime_test.js"></script>
    -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    
    <style>
      body {
        margin: 0;
        font-family: "helvetica neue", roboto;
        color: #614c23;
        background: #f0f0f0;
      }
      .top-bar {
        padding: 5px;
        margin: 0;
        background: gray;
        color:white;
      }
      .content-area {
        padding: 2px 15px;
      }
      .box {
        border: none;
        background: rgba(0,0,0,0.05);
        margin: 1px 1px;
        padding: 1px 3px;
      }
      .col-container {
        display: flex;
        flex-flow: column wrap;
      }
      .stack-up {
        display: flex;
        flex-wrap: wrap;
        flex-flow: column-reverse wrap;
        align-content: flex-end;
      }
      .stack-down {
        display: flex;
        flex-wrap: wrap;
        flex-flow: column;
        align-content: flex-start;
      }
      .row-container {
        display: flex;
        flex-flow: row nowrap;
        overflow-x: auto;
      }
      .scroll {
         overflow-x: scroll;
      }
      
      .pounce-program-list-color {
         background-color: rgba(20, 80, 250, 0.2);
      }
      }
      td {
        vertical-align: top;
      }
      button {
        padding: 4px 7px;
        background-color: rgba(0,0,0,0.1);
        border: none;
      }
    </style>
  </head>
    <body>
      <div class="top-bar">Pounce</div>
      <div class="content-area" id="try_pounce">
        <div class="row-container">
          <canvas id="canvas" width="250" height="150"></canvas>
          <div class="stack-up">
            <select style="font-size:initial;" class="box" v-model="helpWord" v-on:change="lookupWord(helpWord)">
              <option v-for="word in Object.keys(words)" v-bind:value="word">
                {{ word }}
              </option>
            </select>
            <!--
            <div class="box">{{helpWord}} <button v-on:click="helpWordDef = ''" v-show="!helpWordDef">define as a new word</button>
            </div>
            -->
            <div>{{helpWordDef}}</div>
            <div class="box">{{helpWordDesc}}</div>
            <div class="box" v-show="helpWordEffects">net stack effect: {{helpWordEffects}} </div>
            <div class="box" v-show="helpWordExpects">expects: {{helpWordExpects}} </div>
          </div>
        </div>
        <div class="col-container">
          <div class="row-container">
            <div class="box" style="min-width:100px;">
              <canvas id="pounce-animation" width="100" height="61"></canvas>
            </div>
            <div class="col-container">
              <div>
                &nbsp;<label for="runUpToCursor"><input id="runUpToCursor" v-on:change="focusEditor()" v-model="runUpToCursor" type="checkbox" />run Pounce only to cursor</label>
              </div>
              <div>
                <textarea v-model="ps" v-on:keyup="runPounce($event)" v-on:click="runPounce($event)"
                  placeholder="Enter Pounce words here" spellcheck="false"
                  v-focus style="font-size:16px; margin:3px;" class="pounce-program-list-color"
                  rows="3" cols="80"
                  wrap="hard"></textarea>
              </div>
            </div>
          </div>
          <div class="row-container">
            <div class="stack-down  box" style="min-width:200px;">
              <div v-for="ele in vs" class="box">
                {{ ele }} &nbsp;
              </div>
            </div>
              <!--
                <div class="col-container box" style="height:300px; width: 600px;">
                  <div v-for="(value, key) in words" class="box" style="width:100px;">
                    {{ key }}: {{ value.desc }}
                  </div>
                </div>
              -->
            <div class="row-container" style="min-height:300px;">
              <div v-for="h_instance in vs_history" class="stack-down box">
                <!--
                -->
                <div v-for="pl_item in h_instance.pl" class="box pounce-program-list-color" style="width:100px; overflow: hidden;">
                  {{ pl_item }}&nbsp;
                </div>
                <div v-if="h_instance.term" class="box" style="width:100px; overflow: hidden; background-color:rgba(20, 20, 200, 0.3);">
                  {{ h_instance.term }}
                </div>
                <div v-for="item in h_instance.stack" class="box" style="width:100px; overflow: hidden;">
                  {{ item }}&nbsp;
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="content-area" id="examples_section">
        <!--
        <button v-on:click="showExamples = !showExamples">{{ ((showExamples)? 'hide': 'show')}} examples</button> check out these {{ totalexamples }} examples.
        -->
        <div class="column-container" id="some_examples" v-show="showExamples">
          <button v-for="category in tutorials">{{category}}</button>basic
          <div class="row-container" v-for="t in examples.filter(e=>e[1].level === 'basic')">
            <button v-on:click="loadExample(t[0])"><code>{{t[1].summary}}</code></button>
          </div>
          canvas
          <div class="row-container" v-for="t in examples.filter(e=>e[1].level === 'canvas')">
            <button v-on:click="loadExample(t[0])"><code>{{t[1].summary}}</code></button>
          </div>
          advanced
          <div class="row-container" v-for="t in examples.filter(e=>e[1].level === 'advanced')">
            <button v-on:click="loadExample(t[0])"><code>{{t[1].summary}}</code></button>
          </div>
        </div>
      </div>
            <script src="ui/io_canvas_basic.js"></script>

      <script>
      
        function loadExample(s) {
          try_pounce.ps = s;
          try_pounce.runPounce();
          // TBD focus
          // examples_section.examples[s].shown = true;
        }
        var try_pounce = new Vue({
          el: '#try_pounce',
          data: {
            "ps": ""
          , "last_ps": ""
          , "pl": []
          , "vs": []
          , "vs_history": []
          , "words": words
          , "runUpToCursor": false
          , "helpWord": ""
          , "helpWordDef": ""
          , "helpWordDesc": ""
          , "helpWordExpects": ""
          , "helpWordEffects": ""
          },
          methods: {
           "runPounce": function (e) {
              const w = this.wordAtCursor(e);
              this.lookupWord(w);
              if (this.runUpToCursor) {
                this.runPounceToCursor(e);
              }
              else {
                if (this.ps !== this.last_ps) {
                  this.executePounceScript(this.ps);
                }
              }
            }
          , "lookupWord": function (w) {
              this.helpWord = w;
              if (w && words[w]) {
                if (words[w].fn) {
                  this.helpWordDef = 'internal definition'; //words[w].fn;
                }
                else {
                  this.helpWordDef = unParse(words[w]);
                }
                this.helpWordDesc = words[w].desc;
                if (words[w].expects) {
                  this.helpWordExpects =
                    words[w].expects.length + ' item(s)' +
                      words[w].expects.map(i => ' ' + i.desc + ' (' + i.ofType + ')');
                }
                else {
                  if (words[w].expects === []) {
                    this.helpWordExpects = 'nothing';
                  }
                  else {
                    this.helpWordExpects = '';
                  }
                }
                if (words[w].effects) {
                  
                  this.helpWordEffects = '' + words[w].effects[0];
                }
                else {
                  this.helpWordEffects = '';
                }
              }
              else {
                this.helpWordDef = '';
                this.helpWordDesc = '';
                this.helpWordExpects = '';
                this.helpWordEffects = '';
              }

          }
          , "wordAtCursor": function (e) {
              if (e && e.target) {
                const i1a = this.ps.lastIndexOf(' ', e.target.selectionStart-1);
                const i1b = this.ps.lastIndexOf('[', e.target.selectionStart-1);
                const i1c = this.ps.lastIndexOf(']', e.target.selectionStart-1);
                const i1d = this.ps.lastIndexOf('\n', e.target.selectionStart-1);
                let first_i = Math.max(Math.max(Math.max(i1a, i1b), i1c), i1d);
                
                first_i += 1;
              
                let i2a = this.ps.indexOf(' ', e.target.selectionStart);
                if (i2a === -1) {
                  i2a = this.ps.length;
                }
                let i2b = this.ps.indexOf('[', e.target.selectionStart);
                if (i2b === -1) {
                  i2b = this.ps.length;
                }
                let i2c = this.ps.indexOf(']', e.target.selectionStart);
                if (i2c === -1) {
                  i2c = this.ps.length;
                }
                let i2d = this.ps.indexOf('\n', e.target.selectionStart);
                if (i2d === -1) {
                  i2d = this.ps.length;
                }
                let last_i = Math.min(Math.min(Math.min(i2a, i2b), i2c), i2d);
                
                return this.ps.slice(first_i, last_i);
              }
              return '';
            }
          , "runPounceToCursor": function (e) {
              if (e && e.target) {
                if (this.cursorAtWordEnd(e) || /* its not a word */ !words[this.wordAtCursor(e)] ) {
                  // console.log('cursor a end of word: '+proceed);
                  // console.log(e.target.selectionStart, e.target.selectionEnd);
                  // console.log(this.ps.slice(0, e.target.selectionStart));
                  const new_ps = this.ps.slice(0, e.target.selectionStart);
                  if (new_ps !== this.last_ps) {
                    this.executePounceScript(new_ps);
                  }
                }
              }
            }
          , "cursorAtWordEnd": function (e) {
              if (e && e.target) {
                const start_i = e.target.selectionStart;
                //console.log(e.target.selectionStart, e.target.selectionEnd);
                if (start_i < this.ps.length) {
                  const charAfter = this.ps[start_i];
                  if ( charAfter === ' '
                    || charAfter === '{'
                    || charAfter === '['
                    || charAfter === ']'
                    || charAfter === '\n'
                  ) {
                    return true;
                  }
                  return false;
                }
                else {
                  // cursor at end of string
                  return true;
                }
                
              }
            }
          , "focusEditor" : function () {
              //this.focus();
              console.log('deadwood here?');
            }
          , "executePounceScript" : function (pounce_script) {
              if (this.scan_recall(pounce_script)) {
                return;
              }
              this.last_ps = pounce_script;
              this.vs_history = [];
              this.pl = parse(pounce_script);
              this.vs = run(this.pl, [], words, this.vs_history).reverse();
              
              //this.vs_history = this.vs_history.map(e => {
              //  let rt = e;
              //  rt.pl = unParse(e.pl);
              //  rt.stack = unParse(e.stack);
              //  return rt;
              //});
            }
          , 'scan_recall': function (ps) {
                if (ps.indexOf(' recall') >= 1) {
                  const pl = parse(ps);
                  if (pl.length === 2) {
                    let key = pl[0][0];
                    this.ps = '[' + unParse(words[key]) + '] [' + key + '] ';
                    this.vs = [];
                    return true;
                  }
                }
                return false;
              
              //      s.push('recall error: requested word is internal (i.e. defined as a function) and is not divisable into words');
            }
          },
          directives: {
            focus: {
              update: function(el) {
                Vue.nextTick(() => el.focus());
              }
            }
          }
        });
const tutorials = ['start here', 'calculate', 'rearrange the stack', 'your own words', 'some I/O'];
const examples = [
  ['2 3 +', {summary:'Sum of two numbers', desc:'Math is easy to do, the only difference is that the operator (+ for addition) comes after the two numbers being added.', level:'basic'}],
  ['2 3 *', {summary:'Simple Multiplication', desc:'For multiplication, the operator (* for the product or multiplication) is placed after the two numbers to be multiplied.', level:'basic'}],
  ['9 7 + 2.5 /', {summary:'Sum of two numbers', desc:'To add and then divide, say (9 + 7) / 2.4. Notice how no parenthases are needed when the operators are after the numbers. ', level:'basic'}],
  ['9 7 2.4 + /', {summary:'Sum of two numbers', desc:'To divide by a sum, say 9  / (7 + 2.4). Notice how no parenthases are needed when the operators are after the numbers. ', level:'basic'}],
  ['9 7 swap', {summary:'Sum of two numbers', desc:'To divide by a sum, say 9  / (7 + 2.4). Notice how no parenthases are needed when the operators are after the numbers. ', level:'stack operations'}],
  ['1 2 3 dup', {summary:'Sum of two numbers', desc:'To divide by a sum, say 9  / (7 + 2.4). Notice how no parenthases are needed when the operators are after the numbers. ', level:'stack operations'}],
  ['9 7 swap dup',{summary:'Sum of two numbers', desc:'To divide by a sum, say 9  / (7 + 2.4). Notice how no parenthases are needed when the operators are after the numbers. ', level:'stack operations'}],
  ['10 20 30 40 2 bubble-up',{summary:'Sum of two numbers', desc:'To divide by a sum, say 9  / (7 + 2.4). Notice how no parenthases are needed when the operators are after the numbers. ', level:'stack operations'}],
  [
`canvas cb-init cb-clear
4 7 30 112 cb-line
59 122 130 99 cb-line
{color:{r:64 g:0 b:255 a:0.5} x:30 y:40 w:60 h:40} cb-box
{color:{r:255 g:63 b:127 a:0.5} x:60 y:50 w:40 h:50} cb-box
drop
`,{summary:'Draw some shapes', desc:'Draws lines and rectangles on the canvas as a drawing demo', level:'canvas'}],
  [
`canvas cb-init cb-clear
30 45 cb-begin-path
50 60 cb-line-to
100 10 cb-line-to
cb-end-path
drop
`, {summary:'Draw a check-mark', desc:'Draws a line on the canvas', level:'canvas'}],
  [
`[[x set] dip y set] [pack] def
[y get [x get] dip] [unpack] def
canvas cb-init cb-clear
30 45 pack unpack cb-begin-path unpack [20 +] dip 20 + cb-line-to
100 10 cb-line-to cb-end-path
drop
`, {summary:'Turtle Graphics', desc:'Draws a line, relative to possition', level:'canvas'}],
  [
`canvas cb-init cb-clear
images/pounce-cat1.png cb-load-image
`, {summary:'Image on the canvas', desc:'Draws an image on the canvas', level:'canvas'}],
  [
`[ dup 0 > [1 - swap dup dip2 swap repeat] [drop drop] if-else ] [repeat] def
0 1 [] [[swap] dip [dup] dip2 [+] dip swap dup [push] dip swap] 8 repeat`, {summary:'define a word "repeat" and use it to fill an array', desc:'', level:'advanced'}],
[`[n get [p get] dip] [p-n-get] def
[n get [f get] dip] [n-f-get] def
[n get 1 + n set] [n-inc] def
[p-n-get % 0 == [n-f-get push f set p-n-get / p set] [n-inc] if-else] [prime-factor?] def
[p get 1 <= [f get] [prime-factor? 1-p-until] if-else] [1-p-until] def
{n:2 p:210 f:[]} 1-p-until`, {summary:'find the prime factors of a number', desc:'', level:'advanced'}],
[`[[dup] dip2 [dup] dip dup 4 bubble-up 3 bubble-up 2 bubble-up] [dup3] def
4 [15] 6 dup3 [4 push] dip`, {summary:'define dup3', desc:'dup3', level:'advanced'}]
];

        const sortBylevel = (e) => e.sort((a, b) => (level_order[a[1].level] > level_order[b[1].level])? 1: -1);
        const level_order = {basic:1, "stack operations":2, canvas: 3, advanced:4};
        var examples_section = new Vue({
          el: '#examples_section',
          data: {
            "showExamples": true
          , "examples": sortBylevel(examples)
          , "tutorials": tutorials
          , "totalexamples": examples.length
          , "loadExample": loadExample
          },
          methods: {
          }
        });

      </script>

    </body>
</html>
